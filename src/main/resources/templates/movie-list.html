<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">

<head>
    <meta charset="ISO-8859-1">
    <title>Movies<</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>

<header>
    <a href="actors">
        <button>Home</button>
    </a>
    <a href="movie/new">
        <button>Add Movie</button>
    </a>
    <a href="actor/new">
        <button>Add Actor</button>
    </a>
    <a href="actors">
        <button>Actor List</button>
    </a>
</header>

<div class="container">
    <h2>Movies</h2>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Release Date</th>
            <th>Genre</th>
            <th>Actors</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="movie-rows">
        <!--
                <tr th:each="movie : ${movies}">
                    <td th:text="${movie.id}"></td>
                    <td th:text="${movie.title}"></td>
                    <td th:text="${movie.releaseDate}"></td>
                    <td th:text="${movie.genre}"></td>
                    <td>
                        <th:block th:each="actor : ${movie.actors}">
                            <p th:text="${actor.userName}"></p>
                        </th:block>
                    </td>
                    <td>
                        &lt;!&ndash;<a th:href="@{/movies/{id}(id=${movie.id})}">View</a>&ndash;&gt;
                        <a th:href="@{/movie/edit/{id}(id=${movie.id})}">Edit</a>
                        <a th:href="@{/movie/delete/{id}(id=${movie.id})}" onclick="return confirm('Are you sure you want to delete this Movie?')">Delete</a>
                    </td>
                </tr>
        -->
        </tbody>
    </table>
</div>

<script type="application/javascript">

    getMoviesList();

    function addMoviesToDom(movies) {
        const movieRows = document.getElementById("movie-rows");
        movies.forEach(({id, title, releaseDate, genre, actors}) => {
            movieRows.innerHTML += `
                 <tr id=${"movie_id_" + id}>
                    <td>${id}</td>
                    <td>${title}</td>
                    <td>${releaseDate}</td>
                    <td>${genre}</td>
                    <td>
                        <th> ${actors.length > 0 ? actors.map(actor => actor.userName).join(",") : "No Actors"}</th>
                    </td>
                    <td>
                        <button onclick="editMovie(${id}})">Edit</button>
                        <button onclick="deleteMovieById(${id})">Delete</button>
                    </td>
                </tr>
        `;

        })


    }

    function removeMovieFromDom(id) {
        const movieToRemove = document.getElementById("movie_id_" + id);
        console.log(movieToRemove)
        if (movieToRemove != null) {
            movieToRemove.remove();
        }
    }

    function editMovie(id) {
        $.get("/movies/" + id)
            .then(movie => addMoviesToDom(movie))
            .catch(err => console.log(err))
    }

    function deleteMovieById(id) {
        $.ajax(
            {
                async: false,
                type: "DELETE",
                contentType: "application/json",
                dataType: "json",
                url: "/movies/" + id,
                success: ({resultStatus}) => {
                    console.log(resultStatus)
                    if (resultStatus.status === "SUCCESS") {
                        removeMovieFromDom(id);
                        alert("Movie deleted successfully")
                    } else {
                        alert(resultStatus.errorMessage);
                    }
                },
                error: (errorResponse) => {
                    alert("something bad happended!");
                },
            }
        )

    }

    function getMoviesList() {
        $.get("/movies")
            .then(movies => addMoviesToDom(movies))
            .catch(err => console.log(err))

    }
</script>
</body>
</html>